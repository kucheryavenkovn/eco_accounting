
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.ФинОтчет.Пустая() Тогда
		ВызватьИсключение НСтр("ru = 'Не задан фин.отчет для открываемой формы навигации по ошибкам'");
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Параметры.АдресРезультата)
	 Или Не ЭтоАдресВременногоХранилища(Параметры.АдресРезультата) Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Параметры.ПредставленияСтрокОтчетов) Тогда
		// Должна быть структура из двух соответствий Отчеты и Субъекты, где ключ = КлючСтрокиОтчета.
		ВызватьИсключение НСтр("ru = 'Не заданы представления ключей строк для открываемой формы навигации по ошибкам'");
	КонецЕсли;
	
	// Получим информацию из пакета фин.отчетности.
	ИнформацияПакета = ПолучитьИзВременногоХранилища(Параметры.АдресРезультата);
	Если ИнформацияПакета = Неопределено Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	ОтчетностьПоКлючамСтрок = ИнформацияПакета.ОтчетностьПоКлючамСтрок;
	СтрокиБезОшибок = ОтчетностьПоКлючамСтрок.НайтиСтроки(Новый Структура("ОписаниеОшибки", ""));
	Для каждого Отчет Из СтрокиБезОшибок Цикл
		ОтчетностьПоКлючамСтрок.Удалить(Отчет);
	КонецЦикла;
	КлючиСтрокОтчета = Новый Массив;
	Для каждого Отчет Из ОтчетностьПоКлючамСтрок Цикл
		Если ЗначениеЗаполнено(Отчет.КлючСтрокиОтчета) Тогда
			КлючиСтрокОтчета.Добавить(Отчет.КлючСтрокиОтчета);
		КонецЕсли;
	КонецЦикла;

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ФинОтчет", Параметры.ФинОтчет);
	Запрос.УстановитьПараметр("КлючиСтрокОтчета", КлючиСтрокОтчета);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ФинОтчетВБанкОтчетность.КлючСтрокиОтчета КАК КлючСтрокиОтчета,
	|	ФинОтчетВБанкОтчетность.КлючСтрокиСубъекта КАК КлючСтрокиСубъекта
	|ИЗ
	|	Документ.ФинОтчетВБанк.Отчетность КАК ФинОтчетВБанкОтчетность
	|ГДЕ
	|	ФинОтчетВБанкОтчетность.Ссылка = &ФинОтчет
	|	И ФинОтчетВБанкОтчетность.КлючСтрокиОтчета В(&КлючиСтрокОтчета)";
	КлючиСтрокОтчета = Запрос.Выполнить().Выгрузить();
	КлючиСтрокОтчета.Индексы.Добавить("КлючСтрокиОтчета");
	
	ТаблицаСообщенийДерево = РеквизитФормыВЗначение("ТаблицаСообщений");
	СообщенияРегОтчетовДерево = РеквизитФормыВЗначение("СообщенияРегОтчетов");
	
	// Разворачиваем таблицу-входящий параметр в дерево.
	УровеньОтчет = Неопределено;
	ПредставленияСтрокОтчетов = Параметры.ПредставленияСтрокОтчетов;
	ОтборПоКлючу = Новый Структура("КлючСтрокиОтчета");
	Для каждого Отчет Из ОтчетностьПоКлючамСтрок Цикл
		
		СоответствиеКлючей = КлючиСтрокОтчета.Найти(Отчет.КлючСтрокиОтчета, "КлючСтрокиОтчета");
		Если СоответствиеКлючей = Неопределено Тогда
			// Ошибка относится в целом ко всему пакету отчетности.
			УровеньСубъект = ТаблицаСообщенийДерево.Строки.Добавить();
			УровеньСубъект.КлючСтроки     = 99999;
			УровеньСубъект.Представление  = Отчет.Представление;
			УровеньСубъект.ОписаниеОшибки = Отчет.ОписаниеОшибки;
			Продолжить;
			
		КонецЕсли;
		
		УровеньСубъект = ТаблицаСообщенийДерево.Строки.Найти(СоответствиеКлючей.КлючСтрокиСубъекта);
		Если УровеньСубъект = Неопределено Тогда
			
			УровеньСубъект = ТаблицаСообщенийДерево.Строки.Добавить();
			УровеньСубъект.КлючСтроки     = СоответствиеКлючей.КлючСтрокиСубъекта;
			УровеньСубъект.Представление  = ПредставленияСтрокОтчетов.Субъекты[СоответствиеКлючей.КлючСтрокиСубъекта];
			
		КонецЕсли;
		
		Если УровеньОтчет = Неопределено
		 Или УровеньОтчет.КлючСтроки <> Отчет.КлючСтрокиОтчета Тогда

			УровеньОтчет = УровеньСубъект.Строки.Добавить();
			УровеньОтчет.КлючСтроки     = Отчет.КлючСтрокиОтчета;
			УровеньОтчет.Представление  = ПредставленияСтрокОтчетов.Отчеты[Отчет.КлючСтрокиОтчета];
			УровеньОтчет.ОписаниеОшибки = Отчет.ОписаниеОшибки;

		КонецЕсли;
		
		КлючСтрокиРегОтчета = 0;
		Для Каждого РегОтчет Из Отчет.ДетализацияОшибок Цикл
			
			КлючСтрокиРегОтчета = КлючСтрокиРегОтчета + 1;
			
			УровеньРегОтчет = УровеньОтчет.Строки.Добавить();
			УровеньРегОтчет.КлючСтроки     = КлючСтрокиРегОтчета;
			УровеньРегОтчет.Представление  = ?(ПустаяСтрока(РегОтчет.Отчет), Отчет.Представление, РегОтчет.Отчет);
			УровеньРегОтчет.ОписаниеОшибки = РегОтчет.Описание;
			
			СообщениеРегОтчет = СообщенияРегОтчетовДерево.Строки.Найти(РегОтчет.ОтчетДок, "ОтчетДок");
			Если СообщениеРегОтчет = Неопределено Тогда
				
				СообщениеРегОтчет = СообщенияРегОтчетовДерево.Строки.Добавить();
				СообщениеРегОтчет.Отчет            = РегОтчет.Отчет;
				СообщениеРегОтчет.ОтчетДок         = РегОтчет.ОтчетДок;
				СообщениеРегОтчет.КлючСтрокиОтчета = Отчет.КлючСтрокиОтчета;
				
			КонецЕсли;
			
			СообщениеРегОтчет = СообщениеРегОтчет.Строки.Добавить();
			ЗаполнитьЗначенияСвойств(СообщениеРегОтчет, РегОтчет);
			СообщениеРегОтчет.КлючСтрокиОтчета = КлючСтрокиРегОтчета;
			
		КонецЦикла;
	
	КонецЦикла; 
	УдалитьИзВременногоХранилища(Параметры.АдресРезультата);
	
	КоличествоОшибок = 0;
	КоличествоОтчетов = 0;
	Для каждого УровеньСубъект Из ТаблицаСообщенийДерево.Строки Цикл
		
		УровеньСубъект.ОписаниеОшибки = СтрШаблон(НСтр("ru = 'Строк отчетности с ошибками: %1'"),
			УровеньСубъект.Строки.Количество());
			
		Для каждого УровеньОтчет Из УровеньСубъект.Строки Цикл
			
			КоличествоОтчетов = КоличествоОтчетов + 1;

			КоличествоРегОшибок = УровеньОтчет.Строки.Количество();
			Если КоличествоРегОшибок = 0 Тогда
				
				КоличествоОшибок = КоличествоОшибок + 1;
				
			Иначе
				
				КоличествоОшибок = КоличествоОшибок + КоличествоРегОшибок;
				УровеньОтчет.ОписаниеОшибки = СтрШаблон(НСтр("ru = 'Ошибок в отчете: %1'"), КоличествоРегОшибок);
				
			КонецЕсли;
			
		КонецЦикла;
			
	КонецЦикла;
	
	ЗначениеВРеквизитФормы(СообщенияРегОтчетовДерево, "СообщенияРегОтчетов");
	ЗначениеВРеквизитФормы(ТаблицаСообщенийДерево, "ТаблицаСообщений");
	
	НадписьВсегоОшибок = СтрШаблон(НСтр("ru = 'Всего ошибок: %1 в %2 %3'"),
							Формат(КоличествоОшибок, "ЧГ="),
							Формат(КоличествоОтчетов, "ЧГ="),
							?(КоличествоОтчетов = 1, "отчете", "отчетах"));
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ЗакрытьФормуНавигацииПоОшибкамФинОтчетности"
	   И Источник = Параметры.ФинОтчет Тогда
		
		Закрыть();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ТаблицаСообщенийВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекДанные = Элемент.ТекущиеДанные;
	ТекРодитель = ТекДанные.ПолучитьРодителя();
	Если ТекРодитель = Неопределено Тогда
		// Верхний уровень не расшифровываем.
		Возврат;

	КонецЕсли;

	СтандартнаяОбработка = Ложь;
	
	Если ТекРодитель.ПолучитьРодителя() = Неопределено Тогда // переходим к строке пакета отчетности
		
		АктивизироватьСтрокуОтчетности(ТекДанные);
		
	Иначе // переходим к ячейке регламентированного отчета
		
		ОткрываемыйОтчет = Неопределено;
		Для каждого СообщениеРегОтчет Из СообщенияРегОтчетов.ПолучитьЭлементы() Цикл
			Если СообщениеРегОтчет.КлючСтрокиОтчета = ТекРодитель.КлючСтроки Тогда
				ОткрываемыйОтчет = СообщениеРегОтчет;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если ОткрываемыйОтчет = Неопределено Тогда
			Возврат;
		КонецЕсли;
		ОткрываемаяЯчейка = Неопределено;
		Для каждого СообщениеРегОтчет Из ОткрываемыйОтчет.ПолучитьЭлементы() Цикл
			Если СообщениеРегОтчет.КлючСтрокиОтчета = ТекДанные.КлючСтроки Тогда
				ОткрываемаяЯчейка = СообщениеРегОтчет;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если ОткрываемаяЯчейка = Неопределено Тогда
			Возврат;
		КонецЕсли;
		АктивизироватьЯчейкуРегламентированногоОтчета(ОткрываемаяЯчейка);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура АктивизироватьСтрокуОтчетности(ВыбраннаяСтрока)
	
	Отчет = Новый Структура;
	Отчет.Вставить("КлючСтрокиОтчета",   ВыбраннаяСтрока.КлючСтроки);
	Отчет.Вставить("КлючСтрокиСубъекта", ВыбраннаяСтрока.ПолучитьРодителя().КлючСтроки);
	
	ПараметрыФормы = Новый Структура("Ключ", Параметры.ФинОтчет);
	
	ФормаОтчетности = ОткрытьФорму("Документ.ФинОтчетВБанк.Форма.ФормаДокумента", ПараметрыФормы);
	
	ФормаОтчетности.АктивизироватьЯчейку(Отчет);
	
КонецПроцедуры

&НаКлиенте
Процедура АктивизироватьЯчейкуРегламентированногоОтчета(ВыбраннаяСтрока)
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
		
	ТекДок = ВыбраннаяСтрока.ОтчетДок;
	Если ТекДок = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Ячейка = Новый Структура;
	Ячейка.Вставить("Раздел", ВыбраннаяСтрока.Раздел);
	Ячейка.Вставить("Страница", ВыбраннаяСтрока.Страница);
	Ячейка.Вставить("Строка", ВыбраннаяСтрока.Строка);
	Ячейка.Вставить("Графа", ВыбраннаяСтрока.Графа);
	Ячейка.Вставить("СтрокаПП", ВыбраннаяСтрока.СтрокаПП);
	Ячейка.Вставить("ИмяЯчейки", ВыбраннаяСтрока.ИмяЯчейки);
	Ячейка.Вставить("Описание", ВыбраннаяСтрока.Описание);
	
	Попытка
	    // Использован код, взятый из ФормаНавигацииПоОшибкам у документа ВыгрузкаРегламентированныхОтчетов.
		ПараметрыФормы = Новый Структура;
		ПараметрыФормы.Вставить("мДатаНачалаПериодаОтчета");
		ПараметрыФормы.Вставить("мСохраненныйДок");
		ПараметрыФормы.Вставить("мДатаКонцаПериодаОтчета");
		ПараметрыФормы.Вставить("Организация");
		ПараметрыФормы.Вставить("мВыбраннаяФорма");
		ПараметрыФормы.Вставить("ДоступенМеханизмПечатиРеглОтчетностиСДвухмернымШтрихкодомPDF417",
								РегламентированнаяОтчетностьКлиент.ДоступенМеханизмПечатиРеглОтчетностиСДвухмернымШтрихкодомPDF417());
		
		ФормаРеглОтчета = РегламентированнаяОтчетностьВызовСервера.ПолучитьСсылкуНаФормуРеглОтчета(ТекДок, ПараметрыФормы);
		Если СтрНайти(ФормаРеглОтчета, "РегламентированныйОтчетСтатистикаПрочиеФормы") > 0 Тогда
			ФормаРеглОтчета = ?(СтрНайти(ФормаРеглОтчета, "_") = 0, ФормаРеглОтчета, Лев(ФормаРеглОтчета, СтрНайти(ФормаРеглОтчета, "_") - 1));
		КонецЕсли;
		
		Если СтрЧислоВхождений(ФормаРеглОтчета, "ОтчетМенеджер") > 0 Тогда
			
			ФормаРеглОтчета = СтрЗаменить(ФормаРеглОтчета, "ОтчетМенеджер.", "");
			ФормаРеглОтчета = ОткрытьФорму("Отчет." + ФормаРеглОтчета, ПараметрыФормы, , ПараметрыФормы.мСохраненныйДок);
			
		ИначеЕсли СтрЧислоВхождений(ФормаРеглОтчета, "ВнешнийОтчетОбъект") > 0 Тогда
			
			ФормаРеглОтчета = СтрЗаменить(ФормаРеглОтчета, "ВнешнийОтчетОбъект.", "");
			ФормаРеглОтчета = ОткрытьФорму("ВнешнийОтчет." + ФормаРеглОтчета, ПараметрыФормы, , ПараметрыФормы.мСохраненныйДок);
			
		КонецЕсли;
		
		ФормаРеглОтчета.АктивизироватьЯчейку(Ячейка);
	
	Исключение
		// Регистрируем ошибку в журнале регистрации.
		ЗаписьИсключенияВЖурналРегистрации(Параметры.ФинОтчет, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
	КонецПопытки;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаписьИсключенияВЖурналРегистрации(Знач ФинОтчет, Знач Комментарий)
	
	ИмяСобытия = НСтр("ru = 'Переход к ячейке с ошибкой'", ОбщегоНазначения.КодОсновногоЯзыка());
	ЗаписьЖурналаРегистрации(
		ЗаполнениеФинОтчетностиВБанки.СобытиеЖурналаРегистрации(ИмяСобытия),
		УровеньЖурналаРегистрации.Ошибка,
		Метаданные.Документы.ФинОтчетВБанк,
		ФинОтчет,
		Комментарий);

КонецПроцедуры
		
#КонецОбласти