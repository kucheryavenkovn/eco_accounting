
&НаКлиенте
Процедура ПлатежноеПоручениеНажатие(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
		
	Если НЕ ЗначениеЗаполнено(Параметры.Ключ) ИЛИ Модифицированность Тогда
		ОбъектЗаписан = Записать();
		
		Если НЕ ОбъектЗаписан Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;

	Если ЗначениеЗаполнено(ПлатежноеПоручение) Тогда
		ПоказатьЗначение(, ПлатежноеПоручение);
	Иначе//Если НЕ ТолькоПросмотр Тогда
		Если Объект.ПометкаУдаления Тогда
			ПоказатьПредупреждение(, НСтр("ru = 'Нельзя вводить платежку на основании документа, помеченного на удаление!'"));
			Возврат;
		КонецЕсли;
		
		ПараметрыСписания = Новый Структура("Основание", Параметры.Ключ);
		ОткрытьФорму("Документ.ПлатежноеПоручение.Форма.ФормаДокумента", ПараметрыСписания, ЭтотОбъект);
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура СтатусПриИзмененииНаСервере()
	Объект.ДатаУтверждения  = ТекущаяДата();
	Объект.Утвердил = ПараметрыСеанса.ТекущийПользователь;	
КонецПроцедуры

&НаСервере
Функция ДоступныеЭтапы(ТекущийЭтап)
	текПользователь = ПараметрыСеанса.ТекущийПользователь;
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЭтапыСогласованияЗаявок.ПоследующийЭтап КАК ПоследующийЭтап
	|ИЗ
	|	РегистрСведений.ЭтапыСогласованияЗаявок КАК ЭтапыСогласованияЗаявок
	|ГДЕ
	|	ЭтапыСогласованияЗаявок.Пользователь = &Пользователь
	|	И ЭтапыСогласованияЗаявок.ТекущийЭтап = &ТекущийЭтап
	|
	|СГРУППИРОВАТЬ ПО
	|	ЭтапыСогласованияЗаявок.ПоследующийЭтап";
	
	Запрос.УстановитьПараметр("Пользователь", текПользователь);
	Запрос.УстановитьПараметр("ТекущийЭтап", ТекущийЭтап);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	ДоступныеЭтапы = Новый Массив;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ДоступныеЭтапы.Добавить(ВыборкаДетальныеЗаписи.ПоследующийЭтап);
	КонецЦикла;
	
	Возврат ДоступныеЭтапы;
КонецФункции

&НаСервере
Функция ТекДоступКЭтапу(ТекущийЭтап)
	текПользователь = ПараметрыСеанса.ТекущийПользователь;
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЭтапыСогласованияЗаявок.ТекущийЭтап КАК ТекущийЭтап
	|ИЗ
	|	РегистрСведений.ЭтапыСогласованияЗаявок КАК ЭтапыСогласованияЗаявок
	|ГДЕ
	|	ЭтапыСогласованияЗаявок.Пользователь = &Пользователь
	|	И ЭтапыСогласованияЗаявок.ТекущийЭтап = &ТекущийЭтап
	|
	|СГРУППИРОВАТЬ ПО
	|	ЭтапыСогласованияЗаявок.ТекущийЭтап";
	
	Запрос.УстановитьПараметр("Пользователь", текПользователь);
	Запрос.УстановитьПараметр("ТекущийЭтап", ТекущийЭтап);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда 
		Возврат Истина;
	Иначе 
		Возврат Ложь;
	КонецЕсли;;
	
КонецФункции


&НаКлиенте
Процедура СтатусПриИзменении(Элемент)
	СтатусПриИзмененииНаСервере();
	Элементы.Примечание.ТолькоПросмотр = Ложь;
	Объект.Примечание ="";
КонецПроцедуры


&НаКлиенте
Процедура СтатусНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = ложь;
	Элементы.Статус.СписокВыбора.Очистить();	
	СписокСтатусов = ДоступныеЭтапы(Объект.ЭтапСогласования);
	Элементы.Статус.СписокВыбора.ЗагрузитьЗначения(СписокСтатусов);
КонецПроцедуры


&НаКлиенте
Процедура История(Команда)
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Заявка",  Объект.Ссылка);
	ОткрытьФорму("РегистрСведений.ИсторияСогласованияЗаявок.Форма.ФормаПросмотра",ПараметрыФормы,,Объект);	
КонецПроцедуры


&НаСервере
Процедура ВвестиПлатежноеПоручениеНаСервере(ДанныеФормы)
	ЗаполнитьЗначенияСвойств(ДанныеФормы,Объект.Ссылка);
	ПроцентНДС = УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ДанныеФормы.СтавкаНДС);
	ДанныеФормы.видОперации = Перечисления.ВидыОперацийСписаниеДенежныхСредств.ОплатаПоставщику;
	ДанныеФормы.СуммаНДС   = Окр(ДанныеФормы.СуммаДокумента * ПроцентНДС / (100 + ПроцентНДС), 2);
	ДанныеФормы.ИННПолучателя               = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФормы.Контрагент, "ИНН");
	ДанныеФормы.Дата = ТекущаяДата();
	ВалютаРегламентированногоУчета = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();	
	РеквизитыДоговораСтрока = "ВалютаВзаиморасчетов, РасчетыВУсловныхЕдиницах, УчетАгентскогоНДС";
	Если ЗначениеЗаполнено(ДанныеФормы.ДоговорКонтрагента) Тогда
		ДанныеДоговора = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДанныеФормы.ДоговорКонтрагента, РеквизитыДоговораСтрока);
	Иначе
		ДанныеДоговора = Новый Структура(РеквизитыДоговораСтрока, ВалютаРегламентированногоУчета, Ложь, Ложь);
	КонецЕсли;
	
	ВалютаВзаиморасчетов        = ДанныеДоговора.ВалютаВзаиморасчетов;
	Если ЗначениеЗаполнено(ДанныеФормы.ДоговорКонтрагента) Тогда
		ВалютаДокумента     = ВалютаВзаиморасчетов;
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура ВвестиПлатежноеПоручение(Команда)
	
	Форма = ПолучитьФорму("Документ.ПлатежноеПоручение.Форма.ФормаДокумента");
	ДанныеФормы = Форма.Объект;
	
	ВвестиПлатежноеПоручениеНаСервере(ДанныеФормы);
	КопироватьДанныеФормы(ДанныеФормы, Форма.Объект);
	
	Форма.Открыть();
	
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Ключ.Пустая() Тогда
		Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
		Объект.ЭтапСогласования = Перечисления.ЭтапыСогласованияЗаявки.Новая;
	Иначе
	
		ЭтаФорма.ТолькоПросмотр = не ТекДоступКЭтапу(Объект.ЭтапСогласования);
	КонецЕсли;

	Если Объект.ЭтапСогласования = Перечисления.ЭтапыСогласованияЗаявки.Новая Тогда 
		Если   Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь Тогда 
			ЭтаФорма.ТолькоПросмотр = ложь;
		КонецЕсли;
	КонецЕсли;
	
	
	Если Объект.ЭтапСогласования =  Перечисления.ЭтапыСогласованияЗаявки.ФинДиректор Тогда 
		Элементы.ПлатежноеПоручениеНадпись.Доступность = Истина;
	КонецЕсли;
	
	Если Объект.ЭтапСогласования =  Перечисления.ЭтапыСогласованияЗаявки.ФинДиректор или  
		Объект.ЭтапСогласования =  Перечисления.ЭтапыСогласованияЗаявки.ФинКонтроль  Тогда 
		Элементы.УтвержденнаяДатаОплаты.Доступность = Истина;
	КонецЕсли;
	
	ПоказатьПП();
    	
КонецПроцедуры


&НаКлиенте
Процедура ДатаПланируемойОплатыПриИзменении(Элемент)
	Если Параметры.Ключ.Пустая() Тогда
		Объект.УтвержденнаяДатаОплаты = Объект.ДатаПланируемойОплаты;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДоговорКонтрагентаПриИзменении(Элемент)
	Если ЗначениеЗаполнено(Объект.ДоговорКонтрагента) Тогда 
	Объект.ВалютаДокумента = ВернутьВалютуВзаиморасчетов(Объект.ДоговорКонтрагента);
	ЗаполнитьСчет();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСчет()
	Если ЗначениеЗаполнено(Объект.ДоговорКонтрагента.БанковскийСчетДляОплаты) Тогда 
		Объект.БанковскийСчетДляОплаты = Объект.ДоговорКонтрагента.БанковскийСчетДляОплаты;
	Иначе 
		Объект.БанковскийСчетДляОплаты = Объект.Контрагент.ОсновнойБанковскийСчет;
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ВернутьВалютуВзаиморасчетов(ДоговорКонтрагента)
	Возврат	ДоговорКонтрагента.ВалютаВзаиморасчетов;
КонецФункции

&НаСервере
Процедура ПоказатьПП()
ПлатежноеПоручение = НайтиПП();
	
	Если ЗначениеЗаполнено(ПлатежноеПоручение) Тогда 
		ПараметрыДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ПлатежноеПоручение, "Номер, Дата");
		СтрокаДокумент = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ПараметрыДокумента.Номер, Истина, Ложь);
		
		ПлатежноеПоручениеНадпись =СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Платежное поручение № %1 от %2'"),
			СтрокаДокумент,
			Формат(ПараметрыДокумента.Дата, "ДФ=dd.MM.yyyy"));

	Иначе 
		ПлатежноеПоручениеНадпись = "Ввести платежное поручение";
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция НайтиПП()
	ПП = Документы.ПлатежноеПоручение.ПустаяСсылка();
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ДокументСсылка", Объект.Ссылка);
		Запрос.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	ДокСписания.Ссылка
		|ИЗ
		|	Документ.ПлатежноеПоручение КАК ДокСписания
		|ГДЕ
		|	ДокСписания.ДокументОснование = &ДокументСсылка";
		
		ВыборкаИзЗапроса = Запрос.Выполнить().Выбрать();
		
		Если ВыборкаИзЗапроса.Следующий() Тогда
			ПП = ВыборкаИзЗапроса.Ссылка;
		КонецЕсли;
	Возврат ПП;	
КонецФункции

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	ПоказатьПП();
КонецПроцедуры


